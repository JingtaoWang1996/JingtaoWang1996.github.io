---
title: 'Performance-related-notes'
date: 2023-01-12
permalink: /posts/2023/01/Performance-related-notes/
tags:
  - cool posts
  - category1
  - category2
---

Some performance related development notes.

# 相关定律

**性能好的几个常见指标**

* 吞吐量Throughput：单位时间处理的请求量。
* 服务延迟Service Latency：客户请求的处理时间。
* 扩展性 Scalability：系统高压情况下能否正常处理请求。
* 资源使用效率Resource Utilization：单位请求处理所需要的资源量（CPU、内存等）

根据具体场景不同，还可能有其他性能指标。

## 帕累托法则

又名 80/20、关键少数、八二法则。很多场景下20%的因素操控80%的局面，**关键因素在少数**。【eg:80%的销售额来自20%的客户。】

| 场景               | 帕累托法则                     | 指导意义                         |
| ------------------ | ------------------------------ | -------------------------------- |
| 代码使用           | 80%用户使用集中在20%的功能模块 | 常用模块进行充分优化             |
| 开发时间分配       | 80%时间在20%最关键代码开发     | 合理规划好开发时间               |
| 代码维护           | **80%代码改动在20%的代码上**   | 最常改动的少部分代码尽量熟悉     |
| 客户流量和时间分布 | 80%流量在总时间段20%内         | 充分考虑访问时间的峰值和空闲时段 |
| 代码优化           | 80%的时间在运行20%的代码       | 发现少数重点代码并做优化         |

## 阿姆达尔定律

* 衡量处理器进行**并行处理**时总体性能的提升度。
* 用多处理器并行加速时，**总体程序受限于串行时间的百分比。**【串行时间无法通过并行优化，需要改进串行代码本身】

* 实际优化中的意义：优先优化加速占用时间最多的模块，可以最大限度提升效果。

## 利特尔法则

稳定系统中，长期的平均客户数N=客户抵达速度X *客户在这个系统中平均处理时间W

* 设计性能测试环境的基准【设计一个完全能够达到效果的基准】
* 验证测试结果的正确性【调整是否有效】

## 排队论Queuing Theory

* 主要输入参数：请求到达速度、请求到达分布、排队规则、请求处理速度、请求处理模型等。
* 主要输出参数：排队长度、等待时间、系统负载、空闲率等性能指标参数。

# 性能数据展示经验

* 目的：报告性能趋势和流量预测结果；描述性能问题根因分析；建议性能升级和代码优化。
* 展示的难点和挑战：几十上百个指标组合构成的性能数据图数据量大、交互关系负载、牵扯模块多
* 具体展示经验：
  * 不同听众，不同层面展示：向上-宏观；同事-细节。
  * 给足上下文：背景情况介绍详细，确保听众能get到问题点。
  * 总结重点：数据展示完之后，一定要简明的总结重点。

# 一组常用性能数字

每次看到一个性能相关的数据，就能立刻直到这个性能有没有问题。

## 存储相关

存储有很多种，常用的是传统硬盘（Hard Drive Disk) 和 固态硬盘（Solid State Drive）

对所有存储来说的三个基本性能指标：

* IO读写延迟
* IO带宽
* IOPS-每秒可读写多少个小的随机IO

| 存储种类  | 随机4KB-IO延迟 | IO带宽  | 随机IOPS |
| --------- | -------------- | ------- | -------- |
| HDD       | 8ms            | 150MB/S | 120      |
| SSD(SATA) | 100μs          | 500MB/S | 30K      |
| SSD(NVMe) | 20μs           | 4GB/S   | 400K     |

## CPU和内存相关

* 每个指令周期数CPI(Cycles per instruction):平均每条指令的平均时钟周期数。
* 每个周期指令数IPC：虽然一个指令执行需要多个周期，但IPC仍然可以大于1，小于1则性能需要优化。
* MIPS:每秒执行的百万指令数：MIPS越高，CPU性能越好。
  * MIPS= 主频*IPC
* CPU缓存：一般CPU都有L1、L2、L3 级缓存，缓存等级数字越大，缓存越慢但同时成本越低。【L1,L2一般在cpu核上，L3各个核共享。】

## 操作系统和应用程序相关

* 指令分支延迟：CPU需要先获得指令，然后才能执行。获取下一条指令需要知道指令地址（若这个地址需要根据现有指令计算才能确定，则构成指令分支）。

  * CPU通常采取提前提取指令来提高性能，若出现指令分支，就可能导致预测错误，需要十几个时钟周期来重新提取指令，延迟在**10ns左右**

* 互斥加锁和解锁

  保证多线程执行后数据同步，加解锁每个操作都需要几十个时钟周期，**10ns以上**。

* 上下文切换

  多进程or线程共享CPU时，就需要经常做上下文切换，时间消耗在**1μs左右**

  


------

