---
title: '解析服务提供商对非授权域名解析情况的评估-360netlab'
date: 2025-03-29
permalink: /posts/2025/03/解析服务提供商对非授权域名解析情况的评估-360netlab/
tags:
  - DNS security
---

​       DNS权威服务器服务范围探测调研学习过程中，找到一篇文章[《解析服务提供商对非授权域名解析情况的评估-360netlab》](https://blog.netlab.360.com/analysis-of-popular-domain-names-by-non-authorized-resolvers/) 感觉有一定相关度，此文档为学习笔记记录。【blog time：Dec 6,2021】



# 背景

## 现象

specter僵尸网络利用**api.github.com**等白域名提供C&C服务[ref](https://blog.netlab.360.com/specter-domain-whitelist-abuse/)，以此来逃避基于签名和威胁情报匹配的安全产品检测。

## 具体原因

经过分析后，发现其利用“某些域名注册/托管商的**权威DNS服务器**” 在解析非其客户域名方面的漏洞

**本文通过分析权威服务器对非自己服务域名的DNS请求是否能够返回正常应答的情况进行测量和评估**

# 数据选择及评估方法

## 被测域名&选择原因

* **Alexa top500**：500个访问程度上被大量访问的域名。
  
  * eg: google.com、youtube.com 
* 选择原因：
  * 这些域名都会有自己专有的DNS服务器（**每一个域名有自己的专有的权威服务器**），大概率不会使用外部解析提供商的NS服务解析。【类似于许老师说的，自己有自己后台的基础设施&解析服务，不会使用外部的NS解析服务】
  * Alexa 这个域名本身也因为访问量大&业务知名，会被加入到各种白名单中。一些出于探测目的的人也容易基于这些权威域名，随手添加一些知名网站；为了躲避检测黑名单的攻击者，也愿意使用这些白域名。

* 其他域名选择：

  * 360netlab的DNSMon系统可以按照域名在DNS流量中出现的时间跨度、频次、解析稳定性等多维度来计算域名流行程度。

    PS: 选择Alexa top 的原因，基于大众对域名排序的认知。

## 测试权威服务器

* 360netlab的passiveDNS库中提取：**最近半年活跃&为超过500+独立二级域名提供解析服务的权威服务器**
  * 约18469个权威服务器。

## 测试方法

* 具体探测发送：**被测域名（alexa top 500）逐个向测试权威服务器发送UDP/53请求**
  * 如果测试权威服务器DNS返回结果 NOERROR(无论是否有真实的RDATA数据返回)
  * PS：这个测试方法也就类似于服务范围探测时候，向某个权威服务器发送不是其权威域中的某个域名请求，观察响应。
* 可能存在的误差：链路劫持。为了覆盖最广泛的情况，采用UDP/53方式进行数据收集。虽然已经排除了劫持的可能，考虑到复杂链路的情况，少量劫持仍然存在，但不影响整体结论的可靠性。

## 评估结果

### 整体解析情况---向权威服务器发送不是其授权解析的域名

* 18469个权威服务器
  * 98.29% 能够解析到地址：18154
    * **96.33%能够解析到地址并且有响应：17792**
    * 3.67%服务器在做测试的时候出于不活跃状态（选择的是360 netlab- passiveDNS 中仅半年有解析记录的NS）：权威服务提供商基础设施仍然在不断变化中。
* 以能够解析到地址且有响应的17792个权威服务器作为分析基础：
  * 响应率-500个域名的基础上：70.12%【623w7860/(17792*500)】
    * 此处的响应包括所有的响应【noerror、refused】
    * 30%的请求在服务器活跃的情况下丢失->一般由于服务器超时导致。

### 从解析数量方法分析结果-623W中137w个NoError

**70%响应（6237860个响应）的基础上**

* 17792 * 500 * 0.7=6237860

| Rcode    | 比例         |
| -------- | ------------ |
| NoError  | 22%-137w2329 |
| Refused  | 75%-467W8395 |
| SerFail  | 2%-12W4757   |
| NXDomain | 1%-6.23W     |

### 从权威服务器方面

**17792个服务器中，返回过NOERROR的权威服务器有9544个，53.64%**

* 对于每个返回NOERROR的被测服务器（17792中的一个），统计其Alexa Top100的解析占比及全部被测域名（Alexa top500）的解析占比

* 对每个返回NoError的被测服务器，统计其top100的解析占比及所选测试域名top500的占比，可以看出这9544个服务器。

  | 权威服务器排名 | 解析率                 |
  | -------------- | ---------------------- |
  | 1-2250         | 60%以上                |
  | 2250-3300      | 从60%快速下降到20%，   |
  | 3300-6000      | 2%                     |
  | 6000-9544      | 偶尔有少量解析，1%左右 |

  * 即：从360passiveDNS 被动流量数据库中，提取半年活跃&为超过500+独立二级域名提供解析服务的权威服务器18469个权威服务器中，能够对非其权威相应的域名提供解析，且返回NOERROR，同时有较高解析率的权威服务器占比：2250/18469 = 0.12%【这还是筛选过的近半年活跃&为500+独立二级域名提供解析服务的权威服务器的数据】

### 从权威服务器的二级域方面

* 17792个权威服务器(ns4.baidu.com)对应4149个二级域（baidu.com），返回NOERROR记录的二级域1687个，占40.66%。
  * 选定的目标权威服务器大概有40%会返回非自己子域名的解析。
  * 如果这些非自己子域名的解析记录是由域名所有者个人添加的话**，排名越高的域名**，被添加和解析的可能性越大。

### 从域名方面-Alexa top 500 在多少个NS上有解析&占比分布

* 500个域名中，最少被解析的域名为express.dhl.【17792个权威服务器中，只有1483个服务器可以解析它，8.3%】
* 500个域名中，最多被解析的域名为yts.mx。【17792个权威服务器，3114个服务器可以解析它，17.5%】



# 解析结果分析-非权威解析出NOERROR的情况

这些非权威解析出NOERROR情况的服务器将流行域名解析到了哪里？

* 20.92%的数据在二级域名上没有配置有效的DNS记录，但返回NOERROR-被探测域名配置了权威服务器，但没有配置其他类型。

## 解析出ip的情况

* 解析到非权威响应的ip主要在美国(因为top100的域名大部分属于美国的公司或托管在美国的服务器上)-2011年的top10 ip分布见下表

  | 解析到结果的top10数量分布 | 国家/公司            |
  | ------------------------- | -------------------- |
  | 4378                      | United_States        |
  | 579                       | China                |
  | 395                       | Russian_Federation   |
  | 350                       | United_Kingdom       |
  | 216                       | Cloudflare.com[gong] |
  | 213                       | Netherlands          |
  | 212                       | Germany              |
  | 209                       | Japan                |
  | 195                       | South Korea          |
  | 123                       | Singapore            |

* 能够获取到的解析记录很多事127.0.0.1

## 解析结果的错误率

​        在探测top 500的基础上，很多权威服务器对探测域名的解析可能是非授权的，当然也存在非授权的结果正好和授权结果相同的情况。对比非授权和正确结果进行对比，发现：

* **80%的域名（400个）的解析结果错误率在90%以上，最好的错误率也在68%**

# 重要结论

* 从权威服务器的二级域名方面：**选定的17792个NS服务器中，对应4149个二级域，大概会有40%的NS服务器返回非自己客户的域名解析**

  * PS：但是选择单个的基础上，很有可能就无法得到NOERROR

* 从360passiveDNS 被动流量数据库中，提取半年活跃&为超过500+独立二级域名提供解析服务的权威服务器18469个权威服务器中，能够对非其权威相应的域名提供解析，且返回NOERROR，同时有较高解析率的权威服务器占比：2250/18469 = 0.12%

  * 这还是筛选过的近半年活跃&为500+独立二级域名提供解析服务的权威服务器的数据。
  * 选择解析的域名还是流行域名，如果是“城市本地化域名”REFUSED概率理论上更大。

* 具体实例：

  先查询baidu.com的权威服务器ip，随机选择一个权威服务器ip之后，再查询其他任意在Alexa top100之中的google.com 看到的确实是Refused！
  
  <img src="/images/img/权威服务器查询记录实例.png">
  
* **对于流行域名来说，被添加到各种非授权的解析商是非常普遍，但让人非常吃惊的事情。**

  * 流行域名会被添加到非授权解析商，但是能和城市挂钩的非权威

  

# 映射到对于权威服务器服务范围的考虑

## 权威服务器授权响应和非授权响应

* 权威服务器授权响应：
  * 权威DNS服务器在自己配置文件中直接写明了域名与主机对应关系，并被授权管理该域时，可以认为这个DNS是该域的权威DNS。
* 权威服务器非授权响应：
  * 权威服务器对非自己服务域名的请求进行应答（NoError）的情况。
  * nslookup中得到的Non-authoritative answer:从缓存中得到的响应不算在这之中。

## 权威服务器的ip查询方式

* dig ns baidu.com(目标域名)
  * 得到的目标域名的ns记录ip
* dig 目标域名的ns记录的ip a 

# 






------

